<!DOCTYPE html>
<html ng-app>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
  <title>禅道</title>
  <link href="css/mui.min.css" rel="stylesheet"/>
  <link href="css/style.css" rel="stylesheet"/>
  <link href="css/subpage.css" rel="stylesheet"/>
  <link href="css/dialog.css" rel="stylesheet"/>
  <style>
    .dialog > header > div {padding-left: 30px; position: relative;}
    #objStatus {position: absolute; right: 0; top: 4px; margin: 0}
    #timeBar {background: #fafafa; border-bottom: 1px solid #e5e5e5; position: relative; height: 25px; background-color: #86c0ff}
    #timeBar.beyond {background-color: #f37e7a}
    #timeBarLabel {padding: 2px 10px; position: absolute; left: 0; top: 0; bottom: 0; right: 0; z-index: 10}
    #timeBarEstimate, #timeBarConsumed {position: absolute; left: 0; top: 0; bottom: 0; z-index: 5; min-width: 2px}
    #timeBarEstimate {background-color: #5bbce7; background-color: rgba(0,0,0, 0.15);}
    #timeBarConsumed {background-color: #5ee174;}
  </style>
</head>
<body ng-controller="DialogController">
<div class="dialog with-footer" id="dialog">
  <header class="pri">
    <div class="pri-icon" id="priIcon" class="pri"><span class="obj-pri"></span></div>
    <h3><span class="obj-id item-id pri" id="objID"></span> <span class="obj-name"></span></h3>
    <div class="info">
      <div class="small text-muted">所属项目：<strong class="obj-projectName"></strong></div>
      <div class="block-lines">
        <div class="small"><strong>#<span class="obj-typeName"></span></strong> &nbsp;<span id="assignedTo" class="text-muted">指派给 <strong class="obj-assignedTo"></strong> 于 <strong class="obj-assignedDate" data-format="MM月dd日hh:mm"></strong></span><span id="noAssignedTo" class="text-muted">没有指派</span></div>
        <div class="small text-muted">由 <strong class="obj-openedBy">openedBy</strong> 创建于 <strong class="obj-openedDate" data-format="MM月dd日hh:mm"></strong></div>
      </div>
      <div class="mui-badge" id="objStatus"></div>
    </div>
  </header>
  <section id="timeBar">
    <div id="timeBarEstimate"></div>
    <div id="timeBarConsumed"></div>
    <div id="timeBarLabel" class="small"><div class="mui-pull-right">最初预计 <strong class="obj-estimate"></strong></div> 已消耗 <strong class="obj-consumed"></strong> &nbsp; 剩余 <strong class="obj-left"></strong></div>
  </section>
  <section>
    <h5>描述</h5>
    <div class="mui-content-padded obj-desc" data-default="<span class='small text-muted'>--- 没有描述 ---</span>"></div>
  </section>
  <footer>
    <div class="mui-row">
      <div class="mui-col-xs-6 mui-col"><button class="mui-btn mui-btn-block mui-btn-outlined btn-back mui-action-back">返回</button></div>
      <div class="mui-col-xs-6 mui-col mui-col-extra"><button class="mui-btn mui-btn-positive mui-btn-block">完成任务</button></div>
    </div>
  </footer>
</div>
<!-- <script src="js/angular/angular.min.js"></script> -->
<script src="js/core.js"></script>
<script src="js/$.js"></script>
<script src="js/console.js"></script>
<script src="js/store.js"></script>
<script src="js/mui.js"></script>
<script src="js/zentao.js"></script>
<script src="js/webview.js"></script>
<script src="js/dialog.js"></script>
<script>
var options,
    currentView;
var exampleData;
zentao.ready(function()
{
    currentView = plus.webview.currentWebview();
    options = currentView.dialogOptions;
    $('#idid').innerHTML = options.id;

    var obj = zentao.data[options.type].getById(options.id);
    render(obj);
});

function render(obj)
{
    var doms, val, fmt, dft, dVal;
    for(var name in obj)
    {
        doms = $(".obj-" + name),
        val = obj[name];
        if(doms.forEach)
        {
            doms.forEach(function(el)
            {
                fmt = el.getAttribute('data-format');
                dft = el.getAttribute('data-default');
                dVal = dft && (!val) ? dft : val;
                el.innerHTML = fmt ? dVal.format(fmt) : dVal;
            });
        }
        else
        {
            fmt = doms.getAttribute('data-format');
            dft = doms.getAttribute('data-default');
            dVal = dft && (!val) ? dft : val;
            doms.innerHTML = fmt ? dVal.format(fmt) : dVal;
        }
    }

    $("#dialog > header").classList.add('pri-' + obj.pri);
    $("#priIcon").classList.add('pri-' + obj.pri);
    $("#objID").classList.add('pri-' + obj.pri);
    var $status = $('#objStatus');
    $status.innerHTML = obj.statusName;
    $status.classList.add('mui-badge-' + obj.statusColor);
    $("#assignedTo").classList[obj.assignedTo ? 'remove' : 'add']('mui-hidden');
    $('#noAssignedTo').classList[obj.assignedTo ? 'add' : 'remove']('mui-hidden');

    // time bar
    var $timebar = $('#timeBar'),
        maxTime = Math.max(obj.consumed + obj.left, obj.estimate);
    $timebar.classList[maxTime > obj.estimate ? 'add' : 'remove']('beyond');
    $('#timeBarEstimate').style.width = (obj.estimate/maxTime)*100 + '%';
    $('#timeBarConsumed').style.width = (obj.consumed/maxTime)*100 + '%';
}

var assignedDate = new Date(Date.parse("Fri Aug 01 2014 11:16:40 GMT+0800 (CST)"));
</script>
</body>
</html>
