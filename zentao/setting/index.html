<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <title>禅道</title>
    <link href="../css/mui.min.css" rel="stylesheet"/>
    <link href="../css/style.css" rel="stylesheet"/>
    <style>
    #syncIntervalDialog {padding-top: 44px; left: 100%; transition: all 0.15s;}
    #syncIntervalDialog.show.in {left: 0}
    </style>
</head>
<body>
  <header class="mui-bar mui-bar-nav">
    <a class="mui-icon mui-icon-left-nav mui-pull-left mui-action-back"></a>
    <h1 class="mui-title">设置</h1>
  </header>
  <div class="mui-content">
    <h5 style="padding: 8px 10px 2px">帐号</h5>
    <ul class="mui-table-view">
      <li class="mui-table-view-cell"><span class="text-muted">禅道地址 </span><span id="userUrl"></span> <button class="mui-btn" id="openUserUrl">访问</button></li>
      <li class="mui-table-view-cell"><span class="text-muted">当前用户 </span><strong id="userAccount"></strong> <button class="mui-btn mui-btn-danger" id="logoutBtn">注销</button></li>
    </ul>
    <h5 style="padding: 8px 10px 2px">更新与通知</h5>
    <ul class="mui-table-view">
      <li class="mui-table-view-cell">显示通知
        <div class="mui-switch mui-active" id="notifySwitch">
          <div class="mui-switch-handle"></div>
        </div>
      </li>
      <li class="mui-table-view-cell">
        <a class="mui-navigate-right open-dialog">
          <span class="mui-badge mui-badge-inverted" id="syncIntervalOption">10分钟</span>
          自动更新间隔
        </a>
      </li>
    </ul>
  </div>
  <div class="dialog" id="syncIntervalDialog">
    <header class="mui-bar mui-bar-nav">
      <button class="mui-btn mui-btn-link mui-btn-nav mui-pull-left close-dialog"><span class="mui-icon mui-icon-left-nav"></span> 设置</button>
      <h1 class="mui-title">自动更新间隔</h1>
    </header>
    <ul class="mui-table-view" id="syncIntervalList">
      <li class="mui-table-view-cell mui-radio mui-left syncInterval" data-val='20000' data-name="20秒">
        <input id="syncInterval-6000" name="syncInterval" type="radio" value='20000'> 20秒
      </li>
      <li class="mui-table-view-cell mui-radio mui-left syncInterval" data-val='60000' data-name="1分钟">
        <input id="syncInterval-60000" name="syncInterval" type="radio" value='60000'> 1分钟
      </li>
      <li class="mui-table-view-cell mui-radio mui-left syncInterval" data-val='300000' data-name="5分钟">
        <input id="syncInterval-300000" name="syncInterval" type="radio" value='300000'> 5分钟
      </li>
      <li class="mui-table-view-cell mui-radio mui-left syncInterval" data-val='600000' data-name="10分钟">
        <input id="syncInterval-600000" name="syncInterval" type="radio" value='600000'> 10分钟
      </li>
      <li class="mui-table-view-cell mui-radio mui-left syncInterval" data-val='1800000' data-name="30分钟">
        <input id="syncInterval-1800000" name="syncInterval" type="radio" value='1800000'> 30分钟
      </li>
      <li class="mui-table-view-cell mui-radio mui-left syncInterval" data-val='3600000' data-name="60分钟">
        <input id="syncInterval-3600000" name="syncInterval" type="radio" value='3600000'> 60分钟
      </li>
    </ul>
  </div>

<script src="../js/core.js"></script>
<script src="../js/$.js"></script>
<script src="../js/console.js"></script>
<script src="../js/store.js"></script>
<script src="../js/md5.min.js"></script>
<script src="../js/mui.js"></script>
<script src="../js/zentao.js"></script>
<script src="../js/webview.js"></script>
<script>
$('.open-dialog').on('tap', function()
{
    var $dialog = $('#syncIntervalDialog');
    $dialog.classList.add('show');
    setTimeout(function(){$dialog.classList.add('in')}, 100);
});

$('.close-dialog').on('tap', function()
{
    var $dialog = $('#syncIntervalDialog');
    $dialog.classList.remove('in');
    setTimeout(function(){$dialog.classList.remove('show')}, 200);
});

zentao.on('ready', function()
{
    var wv   = plus.webview.currentWebview();
    var user = window.user;

    $('#userUrl').innerHTML     = user.url;
    $('#userAccount').innerHTML = user.account;

    $('#logoutBtn').on('tap', function()
    {
        zentao.logout(false, function(){wv.close('zoom-out', 200);});
    });

    $('#openUserUrl').on('tap', function()
    {
        plus.runtime.openURL(user.url, function()
        {
            alert('无法调用内置浏览器打开。');
        });
    });

    $('#notifySwitch').on('toggle', function(event)
    {
        window.storage.set('receiveNotify', event.detail.isActive);
    });

    $('#notifySwitch .mui-switch-handle').classList[window.storage.get('receiveNotify', true) ? 'add' : 'remove']('mui-acitve');

    $('#syncInterval-' + window.storage.get('syncInterval', 60000)).checked = true;

    document.querySelector("#syncIntervalList").addDelegateListener("tap", ".syncInterval", function(e)
    {
        var that = this;
        setTimeout(function()
        {
            var $dialog = $('#syncIntervalDialog');
            $dialog.classList.remove('in');
            setTimeout(function(){$dialog.classList.remove('show')}, 200);

            window.storage.set('syncInterval', that.getAttribute('data-val'));
            $('#syncIntervalOption').innerHTML = that.getAttribute('data-name');

            mui.fire(plus.webview.currentWebview().opener(), 'restartSync');
        }, 500);
    });
});
</script>
</body>
</html>
